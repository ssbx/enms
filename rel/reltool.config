%% -*- mode: erlang -*-
%% ex: ft=erlang
{sys,
    [
        {lib_dirs, ["../lib", "../deps"]},
        {erts, [{mod_cond, derived}, {app_file, strip}]},
        {app_file, strip},
        {rel, "sysmo", "1.1.0", 
            [
                kernel,
                stdlib,
                sasl,
                sysmo,
                monitor,
                j_server,
                supercast
            ]
        },
        {rel, "start_clean", "",
            [
                kernel,
                stdlib
            ]
        },
        {boot_rel, "sysmo"},
        {profile, embedded},
        {excl_archive_filters, [".*"]},
        {excl_sys_filters, 
            [
                "^bin/(?!start_clean.boot)",
                "^erts.*/bin/(dialyzer|typer)",
                "^erts.*/(doc|info|include|lib|man|src)"
            ]
        },
        {excl_app_filters, ["\.gitignore"]},
        {incl_cond, exclude},
        {app, asn1, [{incl_cond, include}]},
        {app, crypto, [{incl_cond, include}]},
        {app, kernel, [{incl_cond, include}]},
        {app, mnesia, [{incl_cond, include}]},
        {app, public_key, [{incl_cond, include}]},
        {app, sasl, [{incl_cond, include}]},
        {app, ssl, [{incl_cond, include}]},
        {app, stdlib, [{incl_cond, include}]},
        {app, xmerl, [{incl_cond, include}]},
        {app, sysmo, [{incl_cond, include},{lib_dir, ".."}]},
        {app, monitor, [{incl_cond, include}]},
        {app, j_server, [{incl_cond, include}]},
        {app, supercast, [{incl_cond, include}]},
        {app, cowboy, [{incl_cond, include}]},
        {app, cowlib, [{incl_cond, include}]},
        {app, ranch, [{incl_cond, include}]}
    ]
}.

{target_dir, "sysmo"}.

{overlay,
    [
        % myfiles begin
        {copy,  "files/docroot", "docroot"},
        {mkdir, "docroot/sync"},
        {mkdir, "data"},
        {mkdir, "data/monitor"},
        {mkdir, "data/events"},
        {mkdir, "data/states"},
        {mkdir, "etc"},
        {mkdir, "etc/ssl"},
        {copy, "files/users.xml", "etc/users.xml"},
        {copy, "files/ssl/gen_certificates", "etc/ssl/gen_certificates"},

        % java server
        {mkdir, "java_apps"},
        {copy, "../lib/j_server/priv/jserver/sysmo-jserver/build/install/sysmo-jserver",
            "java_apps/sysmo-jserver"},
        {copy, "../lib/j_server/priv/jserver/sysmo-jserver/sysmo.properties",
            "etc/sysmo.properties"},

        % nchecks definitions
        {copy, "../lib/j_server/priv/jserver/shared/nchecks/nchecks-def",
            "docroot/nchecks"},
        {copy, "../lib/j_server/priv/jserver/shared/nchecks/nchecks-def",
            "etc/nchecks"},

        % nchecks jruby scripts
        {mkdir, "ruby"},
        {copy, "../lib/j_server/priv/jserver/shared/nchecks/ruby/*.rb",
            "ruby"},

        {mkdir, "utils"},
        % portable ping is installed with the rakefile

        {mkdir, "log/sasl"},
        {copy, "files/erl", "\{\{erts_vsn\}\}/bin/erl"},
        {copy, "files/nodetool", "releases/\{\{rel_vsn\}\}/nodetool"},
        {copy, "sysmo/bin/start_clean.boot",
            "\{\{erts_vsn\}\}/bin/start_clean.boot"},
        {copy, "files/sysmo", "bin/sysmo"},
        {copy, "files/sysmo.cmd", "bin/sysmo.cmd"},
        {copy, "files/start_erl.cmd", "bin/start_erl.cmd"},
        %% Following line may be safely removed in new projects
        {copy, "files/install_upgrade.escript", "bin/install_upgrade.escript"},
        {copy, "files/sys.config", "etc/app.config"},
        {copy, "files/vm.args", "etc/vm.args"}
    ]
}.
